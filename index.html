<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wordpad at Home</title>
  <style>
    body, button, select, input {
      font-family: -apple-system, "Segoe UI", Tahoma, Ubuntu, Roboto, sans-serif;
    }
    body {
      margin: 0;
    }
    /* Language selector (fixed at top-right) */
    #languageSelector {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1100;
      background: #fff;
      padding: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    /* Toolbar iframe */
    #toolbar {
      width: 100%;
      height: 60px;
      border: none;
      position: fixed;
      top: 0;
      left: 0;
      background: white;
      z-index: 1000;
      overflow: hidden;
      /* Reserve 160px on the right so the toolbar doesn't extend under the selector */
      padding-right: 160px;
    }
    /* Editor area */
    #editor {
      width: 90vw;
      height: calc(90vw * 1.414); /* ~√2 ratio */
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
      text-align: left;
      margin: 70px auto 0;
      font-family: serif; /* Use a serif font inside the editor */
    }
  </style>
</head>
<body>

  <!-- Manual Language Selector -->
  <div id="languageSelector">
    <label for="languageSelect">Language: </label>
    <select id="languageSelect">
      <option value="en">English</option>
      <option value="tr">Türkçe</option>
      <option value="de">Deutsch</option>
      <option value="fr">Français</option>
      <option value="it">Italiano</option>
      <option value="es">Español</option>
      <option value="ru">Русский</option>
    </select>
  </div>

  <!-- Toolbar iframe -->
  <iframe id="toolbar"></iframe>

  <!-- Editor / Textbox -->
  <div id="editor" contenteditable="true"></div>

  <!-- Main Application Script -->
  <script>
    /************************************************
     * 1) Markdown → HTML for WYSIWYG Display
     ***********************************************/
    function extendedMarkdownToHtml(markdown) {
      // 1. Protect code blocks by extracting them into placeholders.
      const codeBlocks = [];
      markdown = markdown.replace(/```([\s\S]*?)```/g, function(match, p1) {
        codeBlocks.push(p1);
        return `@@CODEBLOCK${codeBlocks.length - 1}@@`;
      });
      // 2. Protect inline code similarly.
      const inlineCodes = [];
      markdown = markdown.replace(/`([^`]+)`/g, function(match, p1) {
        inlineCodes.push(p1);
        return `@@INLINECODE${inlineCodes.length - 1}@@`;
      });
      // 3. Process the rest of the markdown.
      let html = markdown;
      // Custom extensions (do these first)
      html = html.replace(/\[u\](.*?)\[\/u\]/gs, '<u>$1</u>');
      html = html.replace(/\[font=([^\]]+)\](.*?)\[\/font\]/gs, '<span style="font-family:$1">$2</span>');
      // Headings
      html = html.replace(/^### (.*)$/gm, '<h3>$1</h3>');
      html = html.replace(/^## (.*)$/gm, '<h2>$1</h2>');
      html = html.replace(/^# (.*)$/gm, '<h1>$1</h1>');
      // Bold & Italic (process bold first)
      html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
      // Blockquotes – allow an optional space after ">"
      html = html.replace(/^>\s?(.*)$/gm, '<blockquote>$1</blockquote>');
      // Horizontal rules – match a full line of three or more dashes
      html = html.replace(/^\s*---+\s*$/gm, '<hr>');
      // Links
      html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>');
      // Numbered lists: convert "1. text" or "1) text" to list items and wrap in <ol>
      html = html.replace(/^(\d+)([.)])\s+(.*)$/gm, '<li data-ordered="true">$3</li>');
      html = html.replace(/((<li data-ordered="true">.*?<\/li>\n?)+)/g, '<ol>$1</ol>');
      html = html.replace(/<li data-ordered="true">/g, '<li>');
      // Bullet lists: convert "- text", "* text", or "+ text" to <li> and wrap consecutive ones in <ul>
      html = html.replace(/^[-*+] (.*)$/gm, '<li>$1</li>');
      html = html.replace(/(<li>(?!.*<\/ol>).+?<\/li>\n?)+/g, function(m) {
        if (m.includes('<ol>') || m.includes('</ol>')) {
          return m; // already inside an ordered list
        }
        return `<ul>${m}</ul>`;
      });
      // Paragraphs: split on double newlines and wrap non–block-level content in <p> tags.
      const blocks = html.split(/\n\s*\n/);
      html = blocks
        .map(block => {
          const trimmed = block.trim();
          if (!trimmed) return '';
          if (/^(<h\d|<ul|<ol|<blockquote|<pre|<hr|<table)/i.test(trimmed)) {
            return trimmed;
          } else {
            const withBr = trimmed.replace(/\n+/g, '<br>\n');
            return `<p>${withBr}</p>`;
          }
        })
        .join('\n');
      // 4. Reinsert the protected inline code segments.
      html = html.replace(/@@INLINECODE(\d+)@@/g, function(match, index) {
        return `<code>${inlineCodes[index]}</code>`;
      });
      // 5. Reinsert the protected code blocks.
      html = html.replace(/@@CODEBLOCK(\d+)@@/g, function(match, index) {
        return `<pre><code>${codeBlocks[index]}</code></pre>`;
      });
      return html;
    }

    /************************************************
     * 2) HTML → Markdown (for Saving)
     ***********************************************/
    function htmlToMarkdown(html) {
      // We'll do a two-step approach:
      // - Convert <ol> & <ul> blocks to lines
      // - Then handle the rest of inline tags

      // 2A) Convert <ol> to numbered lines "1. item", "2. item", etc.
      html = html.replace(/<ol>([\s\S]*?)<\/ol>/gi, function(_, inner) {
        let i = 1;
        const lines = inner.replace(/<li>([\s\S]*?)<\/li>/gi, function(_, liContent) {
          return (i++) + ". " + liContent + "\n";
        });
        return "\n" + lines + "\n";
      });

      // 2B) Convert <ul> to bullet 
